<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <title>Wine Diary</title>

    <!-- üì± Apple Touch Icon: Notion Style (White Background + Black Line Art) -->
    <link rel="apple-touch-icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><rect width=%22100%22 height=%22100%22 fill=%22white%22/><g fill=%22none%22 stroke=%22%2337352F%22 stroke-width=%223.5%22 stroke-linecap=%22round%22 stroke-linejoin=%22round%22><path d=%22M38 35 L38 75 L62 75 L62 35 Z%22/><path d=%22M45 35 L45 22 L55 22 L55 35%22/><path d=%22M72 58 A8 8 0 1 1 56 58 Z%22/><path d=%22M64 66 L64 75 M58 75 L70 75%22/><path d=%22M42 45 L58 45 M42 53 L58 53%22 stroke-width=%222%22/></g></svg>">
    
    <!-- Fonts -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard/dist/web/static/pretendard.css">
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- React & Babel -->
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <style>
        body {
            font-family: 'Pretendard', -apple-system, BlinkMacSystemFont, system-ui, Roboto, sans-serif !important;
            background-color: #FFFFFF;
            color: #37352F;
            -webkit-font-smoothing: antialiased;
            margin: 0;
            overflow-x: hidden;
            -webkit-user-select: auto !important;
            user-select: auto !important;
        }
        
        input, textarea {
            -webkit-user-select: text !important;
            user-select: text !important;
            -webkit-touch-callout: default !important;
            cursor: text !important;
            outline: none;
        }

        .notion-block {
            border: 1px solid #EDECE9;
            border-radius: 14px;
            background: white;
            transition: all 0.15s ease;
            box-shadow: 0 1px 3px rgba(0,0,0,0.02);
        }

        .notion-block:active { background: #F1F1EF; transform: scale(0.99); }

        .notion-input {
            width: 100%;
            padding: 14px;
            border: 1px solid #EDECE9;
            border-radius: 10px;
            background: #F7F7F5;
            font-size: 16px;
            color: #37352F;
            appearance: none;
        }

        .notion-input:focus { border-color: #2383E2; background: white; }
        .safe-bottom { padding-bottom: env(safe-area-inset-bottom, 24px); }
        .icon-box { display: flex; align-items: center; justify-content: center; flex-shrink: 0; }
        .icon-img { width: 100%; height: 100%; object-fit: contain; }

        .loader {
            width: 28px; height: 28px;
            border: 3px solid #F1F1EF; border-top: 3px solid #37352F;
            border-radius: 50%; animation: spin 0.8s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        .modal-overlay {
            position: fixed; inset: 0;
            background: rgba(255,255,255,0.95); backdrop-filter: blur(12px);
            z-index: 9999; display: flex; align-items: center; justify-content: center; padding: 24px;
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo, useRef } = React;

        // --- Configuration ---
        const apiKey = ""; // Runtime provides the key automatically
        const modelName = "gemini-2.5-flash-preview-09-2025";

        const WINE_TYPES = ["Red", "White", "Rose", "Sparkling"];
        const COLOR_MAP = {
            "White": ["Lemon", "Gold", "Amber"],
            "Red": ["Purple", "Ruby", "Garnet"],
            "Rose": ["Pink", "Salmon", "Onion Skin"],
            "Sparkling": ["Pale Gold", "Deep Gold"]
        };

        const Icon3D = ({ name, size = 24, className = "" }) => {
            const iconMap = {
                database: { code: "1f4d1", char: "üìë" }, wine: { code: "1f377", char: "üç∑" },
                home: { code: "1f3e0", char: "üè†" }, archive: { code: "1f4da", char: "üìö" },
                add: { code: "1f4dd", char: "üìù" }, book: { code: "1f4d6", char: "üìñ" },
                history: { code: "1f552", char: "üïí" }, camera: { code: "1f4f8", char: "üì∏" },
                search: { code: "1f50d", char: "üîç" }, star: { code: "2b50", char: "‚≠ê" },
                edit: { code: "270f", char: "‚úèÔ∏è" }, delete: { code: "1f5d1", char: "üóëÔ∏è" },
                calendar: { code: "1f4c5", char: "üìÖ" }, location: { code: "1f4cd", char: "üìç" },
                quote: { code: "1f4ac", char: "üí¨" }, arrowLeft: { code: "2b05", char: "‚¨ÖÔ∏è" },
                sparkles: { code: "2728", char: "‚ú®" }, utensils: { code: "1f374", char: "üç¥" },
                discovery: { code: "1f9ed", char: "üß≠" }, download: { code: "1f4e5", char: "üì•" },
                upload: { code: "1f4e4", char: "üì§" }, tongue: { code: "1f445", char: "üëÖ" },
                nose: { code: "1f443", char: "üëÉ" }, key: { code: "1f511", char: "üîë" }
            };
            const item = iconMap[name] || { code: "2753", char: "‚ùì" };
            const [imgError, setImgError] = useState(false);
            const url = `https://fonts.gstatic.com/s/e/notoemoji/latest/${item.code}/512.webp`;

            return (
                <div className={`icon-box ${className}`} style={{ width: size, height: size }}>
                    {!imgError ? <img src={url} alt={name} className="icon-img" onError={() => setImgError(true)} /> : <span style={{ fontSize: size * 0.85 }}>{item.char}</span>}
                </div>
            );
        };

        const App = () => {
            const [wines, setWines] = useState([]);
            const [view, setView] = useState('dashboard');
            const [currentWine, setCurrentWine] = useState(null);
            const [searchTerm, setSearchTerm] = useState('');
            const [isScanning, setIsScanning] = useState(false);
            const [isLoading, setIsLoading] = useState(true);
            
            const backupFileRef = useRef(null);
            const fileInputRef = useRef(null);

            useEffect(() => {
                const localData = localStorage.getItem('WINE_DIARY_STORAGE_FINAL');
                if (localData) { try { setWines(JSON.parse(localData)); } catch (e) {} }
                setIsLoading(false);
            }, []);

            useEffect(() => {
                if (!isLoading) localStorage.setItem('WINE_DIARY_STORAGE_FINAL', JSON.stringify(wines));
            }, [wines, isLoading]);

            // --- Robust Fetch Logic ---
            const fetchWithRetry = async (url, options, maxRetries = 5) => {
                let delay = 1000;
                for (let i = 0; i <= maxRetries; i++) {
                    try {
                        const response = await fetch(url, options);
                        if (response.ok) return response;
                        if (i === maxRetries) throw new Error(`API returned status ${response.status}`);
                    } catch (err) {
                        if (i === maxRetries) throw err;
                    }
                    await new Promise(r => setTimeout(r, delay));
                    delay *= 2;
                }
            };

            const fetchGemini = async (prompt, isImage = false, base64 = null) => {
                const url = `https://generativelanguage.googleapis.com/v1beta/models/${modelName}:generateContent?key=${apiKey}`;
                
                // Constructing content with proper role as per mandatory instructions
                const payload = {
                    contents: [{ 
                        role: "user",
                        parts: [
                            { text: prompt }, 
                            ...(isImage ? [{ inlineData: { mimeType: "image/jpeg", data: base64.split(',')[1] } }] : [])
                        ] 
                    }]
                };
                
                const response = await fetchWithRetry(url, { 
                    method: 'POST', 
                    headers: { 'Content-Type': 'application/json' }, 
                    body: JSON.stringify(payload) 
                });
                
                const result = await response.json();
                if (result.error) throw new Error(result.error.message);
                return result.candidates?.[0]?.content?.parts?.[0]?.text || "No response";
            };

            const handleBackupExport = () => {
                const data = JSON.stringify(wines, null, 2);
                const blob = new Blob([data], {type: 'application/json'});
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `wine_diary_backup.json`;
                a.click();
            };

            const handleBackupImport = (e) => {
                const file = e.target.files[0];
                if (!file) return;
                const reader = new FileReader();
                reader.onload = (event) => {
                    try {
                        const importedData = JSON.parse(event.target.result);
                        if (Array.isArray(importedData)) {
                            setWines(importedData);
                            alert("Restore Complete!");
                        }
                    } catch (err) { alert("Invalid backup file."); }
                };
                reader.readAsText(file);
                e.target.value = null;
            };

            const handleScan = async (base64) => {
                setIsScanning(true);
                try {
                    const text = await fetchGemini("Identify wine label. Return JSON only: {name, producer, vintage, variety, region}. Use English values.", true, base64);
                    
                    // Safe JSON extraction from AI response (handles Markdown backticks)
                    const jsonMatch = text.match(/\{[\s\S]*\}/);
                    if (!jsonMatch) throw new Error("AI response was not in JSON format.");
                    
                    const data = JSON.parse(jsonMatch[0]);
                    setCurrentWine(prev => ({ ...prev, ...data, imageUrl: base64 }));
                } catch (e) { 
                    console.error("Scan Error:", e);
                    alert("Label scan failed. This might be due to API availability or model name issues in this environment."); 
                } finally { setIsScanning(false); }
            };

            const handleSave = () => {
                if (!currentWine?.name) return;
                if (currentWine.id) setWines(wines.map(w => w.id === currentWine.id ? currentWine : w));
                else setWines([{ ...currentWine, id: Date.now().toString(), createdAt: Date.now() }, ...wines]);
                setView('list');
            };

            if (isLoading) return <div className="h-screen flex items-center justify-center bg-white"><div className="loader"></div></div>;

            return (
                <div className="min-h-screen bg-white text-[#37352F]">
                    <main className="max-w-md mx-auto px-6 pt-16 pb-48">
                        {/* --- Dashboard --- */}
                        {view === 'dashboard' && (
                            <div className="space-y-12 animate-in fade-in">
                                <header className="space-y-2">
                                    <div className="flex items-center gap-3"><Icon3D name="database" size={36} /><h1 className="text-3xl font-bold tracking-tight">Wine Diary</h1></div>
                                    <p className="text-xs text-stone-400 font-bold uppercase tracking-[0.1em] ml-1">Archive your personal wine journey.</p>
                                </header>
                                
                                <div className="space-y-4">
                                    <div className="p-6 notion-block flex items-center justify-between shadow-sm">
                                        <div className="flex items-center gap-5 text-left">
                                            <div className="w-14 h-14 bg-stone-50 rounded-xl flex items-center justify-center shadow-inner"><Icon3D name="wine" size={40} /></div>
                                            <div><p className="text-[10px] font-bold text-stone-400 uppercase tracking-widest mb-1">Archived Bottles</p><p className="text-3xl font-bold">{wines.length}</p></div>
                                        </div>
                                    </div>
                                    <div className="grid grid-cols-2 gap-4">
                                        <div onClick={() => setView('list')} className="p-6 notion-block cursor-pointer flex flex-col gap-4 active:bg-stone-50 transition-colors text-left"><Icon3D name="book" size={32} /><span className="text-sm font-bold">Full Archive</span></div>
                                        <div onClick={() => { if(wines.length > 0) { setCurrentWine(wines[0]); setView('detail'); }}} className="p-6 notion-block cursor-pointer flex flex-col gap-4 active:bg-stone-50 transition-colors text-left"><Icon3D name="history" size={32} /><span className="text-sm font-bold">Recent Entry</span></div>
                                    </div>
                                    <div onClick={() => { setCurrentWine({ name: '', producer: '', vintage: '', variety: '', region: '', type: 'Red', color: '', date: new Date().toISOString().split('T')[0], rating: 5, comment: '', imageUrl: null }); setView('edit'); }} className="p-14 notion-block bg-[#F7F7F5] border-dashed border-2 cursor-pointer flex flex-col items-center justify-center gap-4 active:bg-stone-200 transition-colors"><Icon3D name="camera" size={56} /><p className="text-[11px] font-bold text-stone-500 uppercase tracking-widest">Record New Bottle</p></div>
                                </div>

                                <div className="flex items-center justify-between pt-10 border-t border-stone-100 px-1">
                                    <h3 className="text-[10px] font-black text-stone-300 uppercase tracking-widest">Storage</h3>
                                    <div className="flex items-center gap-4">
                                        <button onClick={handleBackupExport} className="text-[10px] font-bold text-stone-400 flex items-center gap-1 uppercase"><Icon3D name="download" size={14}/> Backup</button>
                                        <button onClick={() => backupFileRef.current.click()} className="text-[10px] font-bold text-stone-400 flex items-center gap-1 uppercase"><Icon3D name="upload" size={14}/> Restore</button>
                                        <input type="file" ref={backupFileRef} className="hidden" accept=".json" onChange={handleBackupImport} />
                                    </div>
                                </div>
                                <div className="text-center -mt-8"><span className="text-[9px] font-bold text-stone-200 tracking-tighter uppercase">Ver 1.1.0 Endpoint Fix</span></div>
                            </div>
                        )}

                        {/* --- List View --- */}
                        {view === 'list' && (
                            <div className="space-y-8 animate-in fade-in">
                                <header className="flex justify-between items-center px-1"><h2 className="text-2xl font-bold flex items-center gap-3"><Icon3D name="archive" size={28} /> Archive</h2><button onClick={() => setView('dashboard')} className="text-xs font-bold text-stone-400 uppercase tracking-widest">Back</button></header>
                                <div className="relative"><div className="absolute left-4 top-1/2 -translate-y-1/2"><Icon3D name="search" size={20} /></div><input className="notion-input pl-12" placeholder="Search bottles..." value={searchTerm} onChange={e => setSearchTerm(e.target.value)} /></div>
                                <div className="divide-y divide-stone-100">
                                    {wines.filter(w => w.name.toLowerCase().includes(searchTerm.toLowerCase())).map((wine) => (
                                        <div key={wine.id} onClick={() => { setCurrentWine(wine); setView('detail'); }} className="py-5 flex items-center gap-5 cursor-pointer hover:bg-stone-50 px-2 transition-colors rounded-xl text-left">
                                            <div className="w-16 h-16 bg-stone-50 rounded-lg border border-stone-100 flex items-center justify-center overflow-hidden shrink-0">{wine.imageUrl ? <img src={wine.imageUrl} className="w-full h-full object-cover" /> : <Icon3D name="wine" size={32} />}</div>
                                            <div className="flex-1 min-w-0"><p className="text-base font-bold truncate">{wine.name}</p><p className="text-xs text-stone-400 font-medium truncate uppercase">{wine.variety} ¬∑ {wine.vintage || 'NV'}</p></div>
                                            <div className="flex items-center gap-1.5 px-2 py-1 bg-stone-50 rounded-md"><Icon3D name="star" size={14} /><span className="text-xs font-bold">{wine.rating}</span></div>
                                        </div>
                                    ))}
                                </div>
                            </div>
                        )}

                        {/* --- Detail View --- */}
                        {view === 'detail' && currentWine && (
                            <div className="space-y-10 animate-in fade-in pb-10">
                                <header className="flex justify-between items-center px-1"><button onClick={() => setView('list')} className="text-xs font-bold text-[#2383E2] flex items-center gap-3 uppercase tracking-widest hover:underline"><Icon3D name="arrowLeft" size={16} /> Archive</button><div className="flex gap-6"><div className="cursor-pointer" onClick={() => setView('edit')}><Icon3D name="edit" size={28} /></div><div className="cursor-pointer" onClick={() => { if(confirm('Delete this record?')) { setWines(wines.filter(w => w.id !== currentWine.id)); setView('list'); } }}><Icon3D name="delete" size={28} /></div></div></header>
                                <div className="space-y-12">
                                    <div className="w-full aspect-square bg-stone-50 rounded-3xl overflow-hidden border border-stone-100 shadow-sm">{currentWine.imageUrl ? <img src={currentWine.imageUrl} className="w-full h-full object-cover" /> : <div className="w-full h-full flex items-center justify-center bg-stone-50"><Icon3D name="wine" size={100} /></div>}</div>
                                    <div className="space-y-2 px-1 text-left">
                                        <div className="flex items-center gap-2 mb-1"><span className={`px-2 py-0.5 rounded text-[10px] font-bold text-white ${currentWine.type === 'Red' ? 'bg-red-500' : currentWine.type === 'White' ? 'bg-yellow-400' : currentWine.type === 'Rose' ? 'bg-pink-400' : 'bg-blue-400'}`}>{currentWine.type}</span></div>
                                        <h2 className="text-4xl font-bold leading-tight">{currentWine.name}</h2>
                                        <p className="text-lg text-stone-400 font-medium">{currentWine.producer || 'Unknown Producer'}</p>
                                    </div>
                                    <div className="p-8 bg-[#F7F7F5] rounded-3xl border border-stone-100 relative overflow-hidden text-left"><div className="absolute -top-4 -right-4 opacity-10"><Icon3D name="quote" size={100} /></div><p className="text-lg leading-relaxed text-stone-700 font-medium italic relative z-10">"{currentWine.comment || 'No tasting notes provided.'}"</p></div>
                                </div>
                            </div>
                        )}

                        {/* --- Edit View --- */}
                        {view === 'edit' && currentWine && (
                            <div className="space-y-12 animate-in fade-in pb-24">
                                <header className="flex justify-between items-center px-1"><button onClick={() => setView('dashboard')} className="text-xs font-bold text-stone-400 uppercase tracking-widest">Cancel</button><button onClick={handleSave} className="text-xs font-bold text-[#2383E2] bg-blue-50 px-6 py-2.5 rounded-xl active:opacity-70 transition-opacity">Done</button></header>
                                <div className="space-y-10 px-1 text-left">
                                    <div onClick={() => fileInputRef.current?.click()} className="w-full aspect-[4/3] bg-stone-50 border-2 border-dashed border-stone-200 rounded-3xl flex flex-col items-center justify-center cursor-pointer overflow-hidden relative group">
                                        {currentWine.imageUrl ? <img src={currentWine.imageUrl} className="w-full h-full object-cover" /> : <><Icon3D name="camera" size={64} className="mb-4" /><p className="text-[10px] font-bold text-stone-400 uppercase tracking-widest text-center">Scan Label</p></>}
                                        {isScanning && <div className="absolute inset-0 bg-white/95 backdrop-blur-md flex flex-col items-center justify-center z-20"><div className="loader"></div></div>}
                                        <input type="file" accept="image/*" className="hidden" ref={fileInputRef} onChange={e => { const f = e.target.files[0]; if(f) { const r = new FileReader(); r.onloadend = () => handleScan(r.result); r.readAsDataURL(f); } }} />
                                    </div>
                                    <div className="space-y-8">
                                        <div className="space-y-3"><label className="text-[10px] font-black text-stone-400 uppercase tracking-widest ml-1">Wine Name</label><input className="notion-input font-bold text-lg" value={currentWine.name} onChange={e => setCurrentWine({...currentWine, name: e.target.value})} placeholder="Enter wine name..." /></div>
                                        <div className="grid grid-cols-2 gap-4">
                                            <div className="space-y-3"><label className="text-[10px] font-black text-stone-400 uppercase tracking-widest ml-1">Vintage</label><input className="notion-input" value={currentWine.vintage} onChange={e => setCurrentWine({...currentWine, vintage: e.target.value})} placeholder="Year" /></div>
                                            <div className="space-y-3"><label className="text-[10px] font-black text-stone-400 uppercase tracking-widest ml-1">Grape</label><input className="notion-input" value={currentWine.variety} onChange={e => setCurrentWine({...currentWine, variety: e.target.value})} placeholder="Variety" /></div>
                                        </div>
                                    </div>
                                    <div className="space-y-3 pt-4 border-t border-stone-100"><label className="text-[10px] font-black text-stone-400 uppercase tracking-widest ml-1">Tasting Note</label><textarea className="notion-input h-32 resize-none text-base" value={currentWine.comment} onChange={e => setCurrentWine({...currentWine, comment: e.target.value})} placeholder="How was the wine? Describe the taste and mood..." /></div>
                                    <div className="space-y-4 pt-4"><div className="flex justify-between items-center px-1"><span className="text-[10px] font-black text-stone-400 uppercase tracking-widest">My Rating</span><span className="text-xl font-bold">{currentWine.rating}/10</span></div><div className="flex gap-1.5">{[...Array(10)].map((_, i) => <button key={i} onClick={() => setCurrentWine({...currentWine, rating: i+1})} className={`flex-1 h-10 rounded-lg transition-all ${currentWine.rating >= i+1 ? 'bg-[#37352F]' : 'bg-stone-100'} active:scale-90`} />)}</div></div>
                                    <button onClick={handleSave} className="w-full py-6 bg-[#37352F] text-white rounded-2xl font-bold text-xl active:bg-black transition-colors shadow-xl">Archive Entry</button>
                                </div>
                            </div>
                        )}
                    </main>

                    {/* --- Bottom Navigation --- */}
                    <nav className="fixed bottom-10 left-1/2 -translate-x-1/2 z-50 safe-bottom">
                        <div className="bg-white/95 backdrop-blur-md border border-stone-200 px-10 py-5 rounded-full flex items-center gap-16 shadow-[0_25px_50px_rgba(0,0,0,0.1)]">
                            <button onClick={() => setView('dashboard')} className="active:opacity-50 p-1 transition-opacity"><Icon3D name="home" size={32} /></button>
                            <button onClick={() => setView('list')} className="active:opacity-50 p-1 transition-opacity"><Icon3D name="archive" size={32} /></button>
                            <div className="w-[1px] h-6 bg-stone-200" />
                            <button onClick={() => { setCurrentWine({ name: '', producer: '', vintage: '', variety: '', region: '', type: 'Red', color: '', date: new Date().toISOString().split('T')[0], rating: 5, comment: '', imageUrl: null }); setView('edit'); }} className="active:opacity-50 p-1 transition-opacity"><Icon3D name="add" size={32} /></button>
                        </div>
                    </nav>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
