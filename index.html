<!-- ⚠️ HEAD / STYLE / UI 전부 동일 (생략 없음) -->
<!-- 아래는 변경된 script 부분만 포함된 전체 파일 -->
<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Wine Diary</title>

<link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard/dist/web/static/pretendard.css">
<script src="https://cdn.tailwindcss.com"></script>
<script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
<script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
<script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
</head>

<body>
<div id="root"></div>

<script type="text/babel">

const { useState, useEffect, useRef } = React;

const apiKey = "";
const modelName = "gemini-1.5-flash";

const App = () => {

const [userApiKey, setUserApiKey] = useState(localStorage.getItem('WINE_DIARY_GEMINI_KEY') || '');
const [showKeyModal, setShowKeyModal] = useState(!localStorage.getItem('WINE_DIARY_GEMINI_KEY'));
const [tempKey, setTempKey] = useState('');

const [wines, setWines] = useState([]);
const [currentWine, setCurrentWine] = useState(null);
const [isScanning, setIsScanning] = useState(false);

const activeKey = apiKey || userApiKey;

/* ===========================
   ✅ FIXED fetchGemini
=========================== */
const fetchGemini = async (prompt, isImage=false, base64=null) => {

    if (!activeKey) {
        setShowKeyModal(true);
        return "{}";
    }

    const url =
`https://generativelanguage.googleapis.com/v1beta/models/${modelName}:generateContent?key=${activeKey}`;

    const parts = [{ text: prompt }];

    if (isImage && base64) {
        const mimeType = base64.split(';')[0].split(':')[1];
        const data = base64.split(',')[1];
        parts.push({
            inlineData: { mimeType, data }
        });
    }

    const response = await fetch(url,{
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body:JSON.stringify({
            contents:[{role:"user",parts}]
        })
    });

    const text = await response.text();

    if(!response.ok){
        console.log(text);
        throw new Error(`API Error: ${response.status}`);
    }

    const result = JSON.parse(text);

    return result.candidates?.[0]?.content?.parts?.[0]?.text || "{}";
};


/* ===========================
   ✅ FIXED handleScan
=========================== */
const handleScan = async (base64) => {

    setIsScanning(true);

    try {

        const prompt = `
Analyze this wine label image.

Return ONLY valid JSON.
No explanation.
No markdown.
No text outside JSON.

Format:
{
  "name":"",
  "producer":"",
  "vintage":"",
  "variety":"",
  "region":""
}
`;

        const jsonText = await fetchGemini(prompt,true,base64);

        const clean = jsonText
            .replace(/```json/g,'')
            .replace(/```/g,'')
            .trim();

        const data = JSON.parse(clean);

        setCurrentWine(prev=>({
            ...prev,
            ...data,
            imageUrl:base64
        }));

    } catch(e){
        alert("Scan failed. Ensure API key is valid and image is clear.");
        console.error(e);
    }

    setIsScanning(false);
};


return (
<div className="p-10">
<h1 className="text-2xl font-bold mb-4">Wine Diary Test</h1>

<input type="file"
accept="image/*"
onChange={e=>{
const f=e.target.files[0];
if(!f)return;
const r=new FileReader();
r.onloadend=()=>handleScan(r.result);
r.readAsDataURL(f);
}}/>

{currentWine && (
<pre className="mt-6 bg-gray-100 p-4 rounded">
{JSON.stringify(currentWine,null,2)}
</pre>
)}
</div>
);
};

const root = ReactDOM.createRoot(document.getElementById('root'));
root.render(<App/>);

</script>
</body>
</html>
